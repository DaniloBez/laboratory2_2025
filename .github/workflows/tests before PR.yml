name: Run Tests on PR

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 23
      uses: actions/setup-java@v4
      with:
        java-version: '23'
        distribution: 'temurin'
        cache: maven

    - name: Build with Maven
      run: mvn -B package --file pom.xml

    - name: Run tests
      run: mvn test

    - name: Generate JaCoCo report
      run: mvn jacoco:report

    - name: Check test coverage
      run: |
        # Встановлюємо xmlstarlet для роботи з XML
        sudo apt-get install -y xmlstarlet
        
        # Отримуємо покриття з JaCoCo
        coverage=$(xmlstarlet sel -t -v "//counter[@type='LINE']/@covered" target/site/jacoco/jacoco.xml)
        total=$(xmlstarlet sel -t -v "//counter[@type='LINE']/@total" target/site/jacoco/jacoco.xml)
        
        # Обчислюємо відсоток покриття
        coverage_percent=$((100 * coverage / total))
        
        echo "Test coverage: $coverage_percent%"

        # Перевіряємо, чи покриття більше або дорівнює 75%
        if [ "$coverage_percent" -lt 75 ]; then
          echo "Test coverage is below 75%, failing the PR."
          exit 1
        fi

    - name: Publish JaCoCo report to GitHub Pages
      run: |
        # Встановлюємо Git для публікації на GitHub Pages
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

        # Перемикаємось на гілку gh-pages
        git checkout gh-pages || git checkout --orphan gh-pages

        # Видаляємо старі файли з попереднього звіту
        git rm -rf .

        # Копіюємо звіт до кореня репозиторію
        cp -r target/site/jacoco/* .

        # Додаємо зміни і комітимо
        git add .
        git commit -m "Deploy JaCoCo report"

        # Пушимо на гілку gh-pages
        git push --force origin gh-pages

    - name: Add GitHub Pages link
      run: echo "JaCoCo Report:https://DaniloBez.github.io/Laboratoty2_2025/"
